<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>Pigmy ‚Üí Computer</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

    <style>
        body {
            padding: 20px;
            font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
        }

        pre {
            height: 250px;
            overflow-y: auto;
            background: #111;
            color: #0f0;
            padding: 10px;
            border-radius: 6px;
        }

        #txn-table {
            max-height: 350px;
            overflow-y: auto;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-light bg-white border-bottom mb-3">
        <div class="container-fluid">
            <span class="navbar-brand">üìü Pigmy ‚Üí Computer
                {% if session.get('branch_name') %}
                    <small class="text-muted"> - {{ session.get('branch_name') }}</small>
                {% endif %}
            </span>

            <div class="ms-auto">
                <a href="/" class="btn btn-outline-secondary btn-sm me-2">üè† Main</a>
                <a href="/logout" class="btn btn-outline-danger btn-sm">üö™ Logout</a>
            </div>
        </div>
    </nav>


    <div class="container">

        <!-- Control Panel -->
        <div class="card p-3 mb-3">

            <div class="row">
                <div class="col-md-4">
                    <label>Select Agent</label>
                    <select id="agent-select" class="form-control"></select>
                </div>

                <div class="col-md-4 d-flex align-items-end">
                    <button id="load-btn" class="btn btn-primary w-100">
                        üì• Load Transactions
                    </button>
                </div>

                <div class="col-md-4 d-flex align-items-end">
                    <button id="download-btn" class="btn btn-success w-100" disabled>
                        ‚¨á Download To Local DB
                    </button>
                </div>
            </div>

            <div class="progress mt-3">
                <div id="progress-bar" class="progress-bar" style="width:0%">0%</div>
            </div>

            <div id="summary" class="fw-bold mt-3">
                Total: 0 | Amount: ‚Çπ0.00
            </div>
        </div>

        <div class="row">

            <div class="col-md-5">
                <pre id="log"></pre>
            </div>

            <div class="col-md-7">
                <div class="card p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0">Transactions</h5>
                        <button id="export-excel-btn" class="btn btn-success btn-sm" disabled>
                            üìä Export to Excel
                        </button>
                    </div>
                    <div id="txn-table"></div>
                </div>
            </div>

        </div>

    </div>

    <script>
        let transactions = [];

        function log(msg) {
            const box = document.getElementById("log");
            box.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
            box.scrollTop = box.scrollHeight;
        }

        function setProgress(v) {
            const bar = document.getElementById("progress-bar");
            bar.style.width = v + "%";
            bar.textContent = v + "%";
        }

        async function initPage() {
            log("Loading agents...");

            const res = await fetch("/api/pig-to-com/agents");
            const data = await res.json();

            let sel = document.getElementById("agent-select");
            sel.innerHTML = "";

            (data.agents || []).forEach(a => {
                let opt = document.createElement("option");
                opt.value = a.ageno;
                opt.text = `Agent ${a.ageno}`;
                sel.add(opt);
            });

            log(`Agents loaded: ${data.agents?.length || 0}`);
        }


        document.getElementById("load-btn").onclick = async () => {
            const agent = document.getElementById("agent-select").value;

            log(`Loading transactions for agent ${agent}...`);
            setProgress(20);

            const resp = await fetch("/api/pig-to-com/load", {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ agent_number: agent })
            });

            const data = await resp.json();

            if (data.error) {
                log("Load error: " + data.error);
                setProgress(0);
                return;
            }

            transactions = data.transactions || [];

            renderTable(transactions);

            document.getElementById("summary").innerText =
                `Total: ${transactions.length} | Amount: ‚Çπ${Number(data.total_amount).toFixed(2)}`;

            document.getElementById("download-btn").disabled = transactions.length === 0;
            document.getElementById("export-excel-btn").disabled = transactions.length === 0;

            setProgress(100);
            log("Load complete.");
        };


        function renderTable(rows) {
            const div = document.getElementById("txn-table");

            if (!rows.length) {
                div.innerHTML = "(No transactions)";
                return;
            }

            let html = `
                <table class="table table-bordered table-sm">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Account</th>
                        <th>Amount</th>
                        <th>Date</th>
                    </tr>
                </thead><tbody>
            `;

            rows.forEach((t, i) => {
                html += `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${t.accnum}</td>
                        <td>‚Çπ${Number(t.amount).toFixed(2)}</td>
                        <td>${t.date}</td>
                    </tr>
                `;
            });

            html += "</tbody></table>";
            div.innerHTML = html;
        }


        document.getElementById("download-btn").onclick = async () => {
            const agent = document.getElementById("agent-select").value;

            log("Download started...");
            setProgress(40);

            const resp = await fetch("/api/pig-to-com/download", {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    agent_number: agent,
                    transactions: transactions
                })
            });

            const data = await resp.json();

            if (!data.success) {
                log("ERROR: " + data.error);
                Swal.fire("Error", data.error, "error");
                setProgress(0);
                return;
            }

            log("Saved to local DB.");
            log(`Total Amount Saved: ‚Çπ${data.total_amount}`);

            Swal.fire("Success", "Downloaded successfully!", "success");

            // Reset UI
            transactions = [];
            document.getElementById("txn-table").innerHTML = "";
            document.getElementById("summary").innerText = "Total: 0 | Amount: ‚Çπ0.00";
            document.getElementById("download-btn").disabled = true;
            document.getElementById("export-excel-btn").disabled = true;

            setProgress(100);
        };


        document.getElementById("export-excel-btn").onclick = async () => {
            if (!transactions.length) {
                alert("No transactions to export!");
                return;
            }

            log("=== EXCEL EXPORT STARTED ===");

            // Get current info
            const agentSelect = document.getElementById("agent-select");
            const agentCode = agentSelect.value;
            const agentText = agentSelect.selectedOptions[0].text;
            const exportTime = new Date().toLocaleString();
            
            // Get branch info from session
            const branchName = "{{ session.get('branch_name', 'N/A') }}";
            const branchCode = "{{ session.get('branch_code', 'N/A') }}";
            
            // Calculate total amount
            let totalAmount = 0;
            transactions.forEach(t => totalAmount += parseFloat(t.amount));

            // Create worksheet with header information
            const ws = XLSX.utils.aoa_to_sheet([
                ['Branch Name:', branchName],
                ['Branch Code:', branchCode],
                ['Agent Code:', agentCode],
                ['Agent Name:', agentText],
                ['Exported Time:', exportTime],
                ['Total Transactions:', transactions.length],
                ['Total Amount:', '‚Çπ' + totalAmount.toFixed(2)],
                [], // Empty row
                ['#', 'Account', 'Amount', 'Date'] // Table header
            ]);

            // Add transaction data
            transactions.forEach((t, i) => {
                XLSX.utils.sheet_add_aoa(ws, [[
                    i + 1,
                    t.accnum,
                    Number(t.amount).toFixed(2),
                    t.date
                ]], { origin: -1 });
            });

            // Set column widths
            ws['!cols'] = [
                { wch: 18 },  // Column A (Labels/#)
                { wch: 30 },  // Column B (Values/Account)
                { wch: 15 },  // Column C (Amount)
                { wch: 12 }   // Column D (Date)
            ];

            // Add borders to all cells
            const range = XLSX.utils.decode_range(ws['!ref']);
            const borderStyle = {
                top: { style: 'thin', color: { rgb: '000000' } },
                bottom: { style: 'thin', color: { rgb: '000000' } },
                left: { style: 'thin', color: { rgb: '000000' } },
                right: { style: 'thin', color: { rgb: '000000' } }
            };

            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                    if (!ws[cellAddress]) continue;
                    
                    if (!ws[cellAddress].s) ws[cellAddress].s = {};
                    ws[cellAddress].s.border = borderStyle;
                    
                    // Bold header row (row 8, index starts at 0)
                    if (R === 8) {
                        ws[cellAddress].s.font = { bold: true };
                        ws[cellAddress].s.fill = { fgColor: { rgb: 'E0E0E0' } };
                    }
                    
                    // Bold labels in info section (Column A, rows 0-6)
                    if (C === 0 && R < 7) {
                        ws[cellAddress].s.font = { bold: true };
                    }
                }
            }

            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Transactions");

            // Generate filename
            const date = new Date().toISOString().split('T')[0];
            const filename = `Pigmy_Transactions_MDB_Agent${agentCode}_${date}.xlsx`;

            // Download
            XLSX.writeFile(wb, filename);

            log(`Exported ${transactions.length} transactions to ${filename}`);
            log("=== EXCEL EXPORT COMPLETE ===");
        };

        document.addEventListener("DOMContentLoaded", initPage);
    </script>

</body>

</html>
