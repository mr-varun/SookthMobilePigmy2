<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Computer ‚Üí Pigmy Machine</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            padding: 20px;
            font-family: system-ui, sans-serif;
        }

        #result-table {
            max-height: 400px;
            overflow-y: auto;
            display: block;
        }

        pre {
            background: #111;
            color: #0f0;
            padding: 10px;
            height: 250px;
            overflow-y: auto;
            border-radius: 6px;
        }

        .monospace {
            font-family: Consolas, monospace;
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom mb-3">
        <div class="container-fluid">
            <span class="navbar-brand">üè¶ Mobile Pigmy Banking
                {% if branch_name or session.get('branch_name') %}
                <small class="text-muted"> - {{ branch_name or session.get('branch_name') }}</small>
                {% endif %}
            </span>

            <div class="ms-auto">
                <a href="/" class="btn btn-outline-secondary btn-sm me-2">üè† Main Menu</a>
                <a href="/logout" class="btn btn-outline-danger btn-sm">üö™ Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">

        <h3>üñ•Ô∏è Computer ‚Üí Pigmy Machine</h3>

        <!-- Control Panel -->
        <div class="card p-3 mb-3">
            <div id="branch-info" class="fw-bold mb-3">Loading branch...</div>

            <div class="row">
                <div class="col-md-4">
                    <label>Select Agent</label>
                    <select id="agent-select" class="form-control"></select>
                </div>

                <div class="col-md-4 d-flex align-items-end">
                    <button id="load-btn" class="btn btn-primary w-100">üìã Load Accounts</button>
                </div>

                <div class="col-md-4 d-flex align-items-end">
                    <button id="upload-btn" class="btn btn-success w-100" disabled>‚¨Ü Upload To Cloud</button>
                </div>
            </div>

            <!-- Progress -->
            <div class="progress mt-3">
                <div id="progress-bar" class="progress-bar" style="width:0%">0%</div>
            </div>

            <div id="summary" class="mt-3 fw-bold">
                Total Accounts: 0 | Total Balance: ‚Çπ0.00
            </div>
        </div>

        <!-- Logs & Accounts -->
        <div class="row g-3">

            <!-- Logs -->
            <div class="col-md-5">
                <div class="card h-100">
                    <div class="card-header">Process Log</div>
                    <div class="card-body">
                        <pre id="log" class="monospace"></pre>
                    </div>
                </div>
            </div>

            <!-- Accounts -->
            <div class="col-md-7">
                <div class="card h-100">
                    <div class="card-header">Account Details</div>
                    <div class="card-body">
                        <div id="result-table"></div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <script>
        let branch = null;
        let accounts = [];

        function log(msg) {
            const box = document.getElementById("log");
            box.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
            box.scrollTop = box.scrollHeight;
        }

        function setProgress(v) {
            const bar = document.getElementById("progress-bar");
            bar.style.width = v + "%";
            bar.textContent = v + "%";
        }

        async function initPage() {
            // Load branch info
            try {
                const br = await fetch("/api/initial-data");
                const bdata = await br.json();
                branch = bdata.branch;
                document.getElementById("branch-info").innerText =
                    `üè¶ ${branch.name} (${branch.code})`;
            } catch (e) {
                log("Branch load failed.");
            }

            // Load agents
            log("Loading agent list from local com_to_pig...");
            const res = await fetch("/api/com-to-pig/agents");
            const data = await res.json();

            const sel = document.getElementById("agent-select");
            sel.innerHTML = "";

            (data.agents || []).forEach(a => {
                let opt = document.createElement("option");
                opt.value = a.agent_number;
                opt.text = `Agent ${a.agent_number}`;
                sel.add(opt);
            });

            log("Agents loaded: " + (data.agents?.length || 0));
        }

        // Load Accounts
        document.getElementById("load-btn").onclick = async () => {
            const agent = document.getElementById("agent-select").value;

            if (!agent) {
                Swal.fire("Select Agent", "Please select agent first.", "warning");
                return;
            }

            log(`Loading accounts for agent ${agent}...`);
            setProgress(10);

            const resp = await fetch("/api/com-to-pig/load", {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ agent_number: agent })
            });

            const data = await resp.json();

            if (data.error) {
                log("Load error: " + data.error);
                setProgress(0);
                return;
            }

            accounts = data.results || [];

            renderTable(accounts);

            document.getElementById("summary").innerText =
                `Total Accounts: ${accounts.length} | Total Balance: ‚Çπ${Number(data.total_balance).toFixed(2)}`;

            log(`Loaded ${accounts.length} accounts.`);
            setProgress(100);

            document.getElementById("upload-btn").disabled = accounts.length === 0;
        };

        // Render table
        function renderTable(rows) {
            if (!rows.length) {
                document.getElementById("result-table").innerHTML = "(No accounts)";
                return;
            }

            let html = `
                <table class="table table-bordered table-sm">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Acc No</th>
                        <th>Name</th>
                        <th>Mobile</th>
                        <th>Balance</th>
                        <th>Date</th>
                    </tr>
                </thead><tbody>
            `;

            rows.forEach(r => {
                html += `
                    <tr>
                        <td>${r.sno}</td>
                        <td>${r.accnum}</td>
                        <td>${r.macnam}</td>
                        <td>${r.mobno}</td>
                        <td>‚Çπ${Number(r.balance).toFixed(2)}</td>
                        <td>${r.depdat || ""}</td>
                    </tr>
                `;
            });

            html += "</tbody></table>";
            document.getElementById("result-table").innerHTML = html;
        }

        // Upload Accounts
        document.getElementById("upload-btn").onclick = async () => {
            if (!accounts.length) {
                Swal.fire("No Accounts", "Please load accounts first.", "warning");
                return;
            }

            const agent = document.getElementById("agent-select").value;
            log("Checking server before upload...");

            setProgress(20);

            const payload = {
                agent_number: agent,
                accounts: accounts
            };

            let res = await fetch("/api/com-to-pig/upload", {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            let result = await res.json();

            // BLOCK
            if (result.requires_action && result.type === "BLOCK") {
                Swal.fire("Upload Blocked", result.message, "error");
                setProgress(0);
                return;
            }

            // CONFIRM
            if (result.requires_action && result.type === "CONFIRM") {
                const confirm = await Swal.fire({
                    title: "Overwrite?",
                    text: result.message,
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Yes, Overwrite"
                });

                if (!confirm.isConfirmed) {
                    return;
                }

                // Re-upload with force
                payload.force = true;

                res = await fetch("/api/com-to-pig/upload", {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                result = await res.json();
            }

            if (result.success) {
                Swal.fire("Success", result.message, "success");
                log("Upload Successful: " + result.message);
                setProgress(100);
            } else {
                Swal.fire("Error", result.message, "error");
                log("Upload Failed: " + result.message);
                setProgress(0);
            }
        };

        document.addEventListener("DOMContentLoaded", initPage);
    </script>

</body>

</html>
