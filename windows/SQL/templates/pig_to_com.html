<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>Pigmy ‚Üí Computer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

    <style>
        body {
            padding: 20px;
        }

        pre {
            height: 200px;
            overflow: auto;
            background: #111;
            color: #0f0;
            padding: 10px;
        }

        table {
            font-family: Consolas;
        }
    </style>
</head>

<body>
    <!-- Navbar with Logout -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom mb-3">
        <div class="container-fluid">
            <span class="navbar-brand">üè¶ Mobile Pigmy Banking
                {% if branch_name or session.get('branch_name') %}
                    <small class="text-muted"> - {{ branch_name or session.get('branch_name') }}</small>
                {% endif %}
            </span>
            <div class="ms-auto">
                <a href="/" class="btn btn-outline-secondary btn-sm me-2">üè† Main Menu</a>
                <a href="/logout" class="btn btn-outline-danger btn-sm">üö™ Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <h3>üìü Pigmy Machine ‚Üí Computer</h3>

        <!-- Selection Panel -->
        <div class="card p-3 mb-3">
            <div id="branch-info" class="fw-bold mb-3">Loading branch...</div>

            <div class="row">
                <div class="col-md-2">
                    <label>Date</label>
                    <input type="date" id="transaction-date" class="form-control" />
                </div>

                <div class="col-md-3">
                    <label>Deposit Type</label>
                    <select id="deposit-type" class="form-control"></select>
                </div>

                <div class="col-md-4">
                    <label>Agent</label>
                    <select id="agent-select" class="form-control"></select>
                </div>

                <div class="col-md-3 d-flex align-items-end">
                    <button id="load-btn" class="btn btn-primary w-100">üì• Load Transactions</button>
                </div>
            </div>
        </div>

        <!-- Transaction List -->
        <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 id="summary" class="mb-0">Total: 0 | Amount: ‚Çπ0.00</h5>
                <button id="export-excel-btn" class="btn btn-success btn-sm" disabled>
                    üìä Export to Excel
                </button>
            </div>

            <div id="txn-table"></div>

            <button id="download-btn" class="btn btn-success mt-3 w-100" disabled>
                ‚¨á Download To Local DB
            </button>
        </div>

        <div class="card p-3 mt-3">
            <h5>Real-Time Log</h5>
            <pre id="log"></pre>
        </div>

    </div>

    <script>
        let transactions = [];
        let branchData = null;

        function log(msg) {
            const box = document.getElementById("log");
            box.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
            box.scrollTop = box.scrollHeight;
        }

        // Load branch + deposit types + agents
        async function initPage() {
            const resp = await fetch('/api/initial-data');
            const data = await resp.json();

            branchData = data.branch;
            document.getElementById("branch-info").innerText =
                `üè¶ ${branchData.name} (${branchData.code})`;

            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById("transaction-date").value = today;

            // Deposit type
            const dsel = document.getElementById("deposit-type");
            data.types.forEach(t => {
                const opt = document.createElement("option");
                opt.value = t; opt.text = t; dsel.add(opt);
            });

            // Agents
            await loadAgents();
        }

        async function loadAgents() {
            const type = document.getElementById("deposit-type").value;
            const resp = await fetch(`/api/agents?type=${type}&branch=${branchData.code}`);
            const data = await resp.json();

            const asel = document.getElementById("agent-select");
            asel.innerHTML = "";

            data.agents.forEach(a => {
                const opt = document.createElement("option");
                opt.value = a.agent_number;
                opt.text = `${a.agent_name} (${a.agent_number})`;
                asel.add(opt);
            });
        }

        document.getElementById("deposit-type").addEventListener("change", loadAgents);

        document.getElementById("load-btn").onclick = async () => {

            const type = document.getElementById("deposit-type").value;
            const agent = document.getElementById("agent-select").value;
            const agentText = document.getElementById("agent-select").selectedOptions[0].text;

            log("=== LOAD STARTED ===");
            log("Deposit Type: " + type);
            log("Agent: " + agentText);
            log("Fixed Remote Branch Code: 101");

            const resp = await fetch("/api/pig-to-com/load", {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    agent_number: agent,
                    deposit_type: type
                })
            });

            const data = await resp.json();

            // Log SQL Query
            log("SQL EXECUTED:");
            log(data.sql);

            transactions = data.transactions || [];

            // Summary
            let total = 0;
            transactions.forEach(t => total += parseFloat(t.amount));

            document.getElementById("summary").innerText =
                `Total: ${transactions.length} | Amount: ‚Çπ${total.toFixed(2)}`;

            document.getElementById("download-btn").disabled = transactions.length === 0;

            renderTable(transactions);

            log(`Loaded ${transactions.length} records.`);
            log("=== LOAD COMPLETE ===");
            
            // Enable/disable export button
            document.getElementById("export-excel-btn").disabled = transactions.length === 0;
        };

        function renderTable(rows) {
            const div = document.getElementById("txn-table");

            if (!rows.length) {
                div.innerHTML = "(No records)";
                return;
            }

            let html = `
    <table class="table table-bordered table-sm">
      <thead>
        <tr>
          <th>#</th>
          <th>Account</th>
          <th>Name</th>
          <th>Date</th>
          <th>Amount</th>
        </tr>
      </thead><tbody>
  `;

            rows.forEach((t, i) => {
                html += `
      <tr>
        <td>${i + 1}</td>
        <td>${t.accnum}</td>
        <td>${t.name}</td>
        <td>${t.date}</td>
        <td>‚Çπ${Number(t.amount).toFixed(2)}</td>
      </tr>
    `;
            });

            html += "</tbody></table>";

            div.innerHTML = html;
        }

        document.getElementById("download-btn").onclick = async () => {
            const type = document.getElementById("deposit-type").value;
            const agent = document.getElementById("agent-select").value;
            const selectedDate = document.getElementById("transaction-date").value;

            log("=== DOWNLOAD STARTED ===");
            log("Deposit Type: " + type);
            log("Agent Code: " + agent);
            log("Transaction Date: " + selectedDate);

            const resp = await fetch("/api/pig-to-com/download", {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    agent_number: agent,
                    deposit_type: type,
                    transaction_date: selectedDate,
                    transactions: transactions
                })
            });

            const data = await resp.json();

            if (data.success) {
                log("INSERT SQL Template:");
                log(data.insert_sql);

                log("UPDATE SQL Template:");
                log(data.update_sql);

                log("Total Amount Inserted: ‚Çπ" + data.total_amount);
                log("=== DOWNLOAD COMPLETE ===");

                alert("Transactions Downloaded Successfully!");

                // Reset UI
                transactions = [];
                document.getElementById("summary").innerText = "Total: 0 | Amount: ‚Çπ0.00";
                document.getElementById("txn-table").innerHTML = "";
                document.getElementById("download-btn").disabled = true;
                document.getElementById("export-excel-btn").disabled = true;

            } else {
                log("ERROR: " + data.error);
            }
        };

        document.getElementById("export-excel-btn").onclick = () => {
            if (!transactions.length) {
                alert("No transactions to export!");
                return;
            }

            log("=== EXCEL EXPORT STARTED ===");

            // Get current info
            const type = document.getElementById("deposit-type").value;
            const agentSelect = document.getElementById("agent-select");
            const agentCode = agentSelect.value;
            const agentFullText = agentSelect.selectedOptions[0].text;
            const agentName = agentFullText.split('(')[0].trim();
            const date = document.getElementById("transaction-date").value || new Date().toISOString().split('T')[0];
            const exportTime = new Date().toLocaleString();
            
            // Calculate total amount
            let totalAmount = 0;
            transactions.forEach(t => totalAmount += parseFloat(t.amount));

            // Create worksheet with header information
            const ws = XLSX.utils.aoa_to_sheet([
                ['Branch Name:', branchData.name],
                ['Branch Code:', branchData.code],
                ['Agent Code:', agentCode],
                ['Agent Name:', agentName],
                ['Deposit Type:', type],
                ['Transaction Date:', date],
                ['Exported Time:', exportTime],
                ['Total Transactions:', transactions.length],
                ['Total Amount:', '‚Çπ' + totalAmount.toFixed(2)],
                [], // Empty row
                ['#', 'Account', 'Name', 'Date', 'Amount'] // Table header
            ]);

            // Add transaction data
            transactions.forEach((t, i) => {
                XLSX.utils.sheet_add_aoa(ws, [[
                    i + 1,
                    t.accnum,
                    t.name,
                    t.date,
                    Number(t.amount).toFixed(2)
                ]], { origin: -1 });
            });

            // Set column widths
            ws['!cols'] = [
                { wch: 18 },  // Column A (Labels/#)
                { wch: 30 },  // Column B (Values/Account)
                { wch: 30 },  // Column C (Name)
                { wch: 12 },  // Column D (Date)
                { wch: 12 }   // Column E (Amount)
            ];

            // Add borders to all cells
            const range = XLSX.utils.decode_range(ws['!ref']);
            const borderStyle = {
                top: { style: 'thin', color: { rgb: '000000' } },
                bottom: { style: 'thin', color: { rgb: '000000' } },
                left: { style: 'thin', color: { rgb: '000000' } },
                right: { style: 'thin', color: { rgb: '000000' } }
            };

            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                    if (!ws[cellAddress]) continue;
                    
                    if (!ws[cellAddress].s) ws[cellAddress].s = {};
                    ws[cellAddress].s.border = borderStyle;
                    
                    // Bold header row (row 10, index starts at 0)
                    if (R === 10) {
                        ws[cellAddress].s.font = { bold: true };
                        ws[cellAddress].s.fill = { fgColor: { rgb: 'E0E0E0' } };
                    }
                    
                    // Bold labels in info section (Column A, rows 0-8)
                    if (C === 0 && R < 9) {
                        ws[cellAddress].s.font = { bold: true };
                    }
                }
            }

            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Transactions");

            // Generate filename
            const filename = `Pigmy_Transactions_${type}_${date}.xlsx`;

            // Download
            XLSX.writeFile(wb, filename);

            log(`Exported ${transactions.length} transactions to ${filename}`);
            log("=== EXCEL EXPORT COMPLETE ===");
        };

        document.addEventListener("DOMContentLoaded", initPage);
    </script>

</body>

</html>